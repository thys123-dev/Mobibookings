<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zoho CRM - Fix Refresh Token</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            line-height: 1.6;
        }

        .step {
            background: #f5f5f5;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #007cba;
        }

        .code {
            background: #f0f0f0;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            overflow-x: auto;
        }

        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
        }

        .success {
            background: #d1edff;
            border: 1px solid #74b9ff;
            color: #0984e3;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
        }

        .error {
            background: #ffe6e6;
            border: 1px solid #ff7979;
            color: #d63031;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
        }

        button {
            background: #007cba;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }

        button:hover {
            background: #005a87;
        }

        .option {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
        }
    </style>
</head>

<body>
    <h1>üîß Fix Zoho CRM Refresh Token</h1>

    <div class="error">
        <strong>Diagnosis Complete!</strong><br>
        ‚úÖ Your client is registered in the <strong>US domain</strong><br>
        ‚ùå Your refresh token is <strong>invalid/revoked</strong><br>
        <br>
        <strong>Root Cause:</strong> The refresh token was likely revoked when you generated a new one, or there's a
        redirect URI mismatch.
    </div>

    <h2>üéØ Choose Your Solution:</h2>

    <div class="option">
        <h3>Option 1: Client Credentials Flow (Recommended for Testing)</h3>
        <p><strong>‚úÖ Pros:</strong> Simple, no redirect URI needed, perfect for testing</p>
        <p><strong>‚ö†Ô∏è Requirement:</strong> Need your Organization ID (zsoid)</p>
        <button onclick="showClientCredentials()">Use Client Credentials</button>
        <div id="clientCredentialsDiv" style="display:none; margin-top: 15px;">
            <p><strong>Step 1:</strong> Get your Organization ID from Zoho CRM:</p>
            <ol>
                <li>Go to your Zoho CRM</li>
                <li>Click your profile picture (top right)</li>
                <li>Look for "Org ID" in the dropdown</li>
                <li>It should look like: <code>60012345678</code></li>
            </ol>
            <input type="text" id="orgId" placeholder="Enter your Org ID (e.g., 60012345678)"
                style="width: 100%; padding: 10px; margin: 10px 0;">
            <button onclick="generateClientCredentials()">Generate Access Token</button>
            <div id="clientCredentialsResult"></div>
        </div>
    </div>

    <div class="option">
        <h3>Option 2: Generate New Refresh Token</h3>
        <p><strong>‚úÖ Pros:</strong> Permanent solution, tokens don't expire</p>
        <p><strong>‚ö†Ô∏è Requirement:</strong> Must use the exact same redirect URI as registered in your Connected App</p>
        <button onclick="showRefreshTokenFlow()">Generate New Refresh Token</button>
        <div id="refreshTokenDiv" style="display:none; margin-top: 15px;">
            <div class="warning">
                <strong>Important:</strong> You must use the <strong>exact same redirect URI</strong> that you
                registered in your Zoho Connected App. Check your Connected App settings first!
            </div>
            <p><strong>Common redirect URIs:</strong></p>
            <div class="code">
                https://developer.zoho.com/
                http://localhost:3000/callback
                https://your-domain.com/callback
            </div>
            <input type="text" id="redirectUri" placeholder="Enter your registered redirect URI"
                value="https://developer.zoho.com/" style="width: 100%; padding: 10px; margin: 10px 0;">
            <button onclick="getNewAuthCode()">Get Authorization Code</button>

            <div id="newAuthInstructions" style="display:none; margin-top: 20px;">
                <input type="text" id="newAuthCode" placeholder="Paste authorization code here..."
                    style="width: 100%; padding: 10px; margin: 10px 0;">
                <button onclick="getNewRefreshToken()">Exchange for Refresh Token</button>
                <div id="newRefreshResult"></div>
            </div>
        </div>
    </div>

    <script>
        const CLIENT_ID = '1000.1YSY4617U5T2XOO7YND2LKE7YOCBLA';
        const CLIENT_SECRET = '5e7776e4df6797e625fd73542a2fa56506c9641156';

        function showClientCredentials() {
            document.getElementById('clientCredentialsDiv').style.display = 'block';
            document.getElementById('refreshTokenDiv').style.display = 'none';
        }

        function showRefreshTokenFlow() {
            document.getElementById('refreshTokenDiv').style.display = 'block';
            document.getElementById('clientCredentialsDiv').style.display = 'none';
        }

        async function generateClientCredentials() {
            const orgId = document.getElementById('orgId').value.trim();
            const resultDiv = document.getElementById('clientCredentialsResult');

            if (!orgId) {
                resultDiv.innerHTML = '<div class="warning">Please enter your Organization ID first.</div>';
                return;
            }

            resultDiv.innerHTML = '<p>üîÑ Generating access token using Client Credentials flow...</p>';

            const scope = 'ZohoCRM.modules.ALL,ZohoCRM.settings.ALL';
            const soid = `ZohoCRM.${orgId}`;

            const url = `https://accounts.zoho.com/oauth/v2/auth?client_id=${CLIENT_ID}&client_secret=${CLIENT_SECRET}&grant_type=client_credentials&scope=${encodeURIComponent(scope)}&soid=${encodeURIComponent(soid)}`;

            try {
                const response = await fetch(url, { method: 'POST' });
                const data = await response.json();

                if (data.access_token) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h3>‚úÖ Success! Client Credentials Access Token Generated:</h3>
                            <div class="code">
Access Token: ${data.access_token}
API Domain: ${data.api_domain}
Expires In: ${data.expires_in} seconds (1 hour)
                            </div>
                            <p><strong>Next steps:</strong></p>
                            <ol>
                                <li>Add these to your .env.local file (optional)</li>
                                <li>Update your auth.ts to use Client Credentials flow</li>
                                <li>Test the field metadata API</li>
                            </ol>
                            <p><strong>Note:</strong> This token expires in 1 hour. For production, use the refresh token flow.</p>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="warning">
                            <h3>‚ùå Error:</h3>
                            <div class="code">${JSON.stringify(data, null, 2)}</div>
                            <p><strong>Check:</strong></p>
                            <ul>
                                <li>Organization ID is correct</li>
                                <li>Client has proper scopes enabled</li>
                            </ul>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="warning">
                        <h3>‚ùå Network Error:</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        function getNewAuthCode() {
            const redirectUri = document.getElementById('redirectUri').value.trim();
            if (!redirectUri) {
                alert('Please enter your registered redirect URI first');
                return;
            }

            const authUrl = `https://accounts.zoho.com/oauth/v2/auth?scope=ZohoCRM.modules.ALL,ZohoCRM.settings.ALL&client_id=${CLIENT_ID}&response_type=code&access_type=offline&redirect_uri=${encodeURIComponent(redirectUri)}`;

            document.getElementById('newAuthInstructions').style.display = 'block';
            window.open(authUrl, '_blank');
        }

        async function getNewRefreshToken() {
            const authCode = document.getElementById('newAuthCode').value.trim();
            const redirectUri = document.getElementById('redirectUri').value.trim();
            const resultDiv = document.getElementById('newRefreshResult');

            if (!authCode || !redirectUri) {
                resultDiv.innerHTML = '<div class="warning">Please enter both authorization code and redirect URI.</div>';
                return;
            }

            resultDiv.innerHTML = '<p>üîÑ Exchanging authorization code for refresh token...</p>';

            try {
                const response = await fetch('https://accounts.zoho.com/oauth/v2/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        grant_type: 'authorization_code',
                        client_id: CLIENT_ID,
                        client_secret: CLIENT_SECRET,
                        redirect_uri: redirectUri,
                        code: authCode
                    })
                });

                const data = await response.json();

                if (data.access_token && data.refresh_token) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h3>‚úÖ Success! New Refresh Token Generated:</h3>
                            <div class="code">
ZOHO_CLIENT_ID=1000.1YSY4617U5T2XOO7YND2LKE7YOCBLA
ZOHO_CLIENT_SECRET=5e7776e4df6797e625fd73542a2fa56506c9641156
ZOHO_REFRESH_TOKEN=${data.refresh_token}
                            </div>
                            <p><strong>Next steps:</strong></p>
                            <ol>
                                <li>Update your .env.local file with the new refresh token</li>
                                <li>Restart your development server</li>
                                <li>Test the field metadata API</li>
                            </ol>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="warning">
                            <h3>‚ùå Error:</h3>
                            <div class="code">${JSON.stringify(data, null, 2)}</div>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="warning">
                        <h3>‚ùå Network Error:</h3>
                        <p>${error.message}</p>
                        <p>Try the manual curl method instead.</p>
                    </div>
                `;
            }
        }
    </script>
</body>

</html>